name: ğŸ©º Nightly System Health Check

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2:00 ØµØ¨Ø§Ø­Ø§Ù‹ UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    inputs:
      comprehensive_check:
        description: 'ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø´Ø§Ù…Ù„ (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ©)'
        required: false
        default: 'false'
        type: boolean
      auto_fix:
        description: 'Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø´Ø§ÙƒÙ„'
        required: false
        default: 'true'
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'AccountingSystem.sln'
  DOCTOR_PROJECT: 'AccountingSystem.Doctor'

jobs:
  system-health-check:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Restore Dependencies
      run: |
        dotnet restore ${{ env.SOLUTION_PATH }}

    - name: ğŸ—ï¸ Build Solution
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

    - name: ğŸ©º Run System Diagnostics
      id: diagnostics
      run: |
        # ØªØ´ØºÙŠÙ„ Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (${{ github.event.inputs.comprehensive_check == 'true' }}) {
          dotnet run --project ${{ env.DOCTOR_PROJECT }} -- --comprehensive --output-format json --output-file health-report.json
        } else {
          dotnet run --project ${{ env.DOCTOR_PROJECT }} -- --quick --output-format json --output-file health-report.json
        }
      continue-on-error: true

    - name: ğŸ”§ Auto Fix Issues (if enabled)
      if: ${{ github.event.inputs.auto_fix == 'true' || github.event.inputs.auto_fix == null }}
      run: |
        dotnet run --project ${{ env.DOCTOR_PROJECT }} -- --fix --safe-only --output-format json --output-file fix-report.json
      continue-on-error: true

    - name: ğŸ“Š Generate Performance Report
      run: |
        dotnet run --project ${{ env.DOCTOR_PROJECT }} -- --performance-test --output-format html --output-file performance-report.html
      continue-on-error: true

    - name: ğŸ–¼ï¸ Run Visual Regression Tests (if comprehensive)
      if: ${{ github.event.inputs.comprehensive_check == 'true' }}
      run: |
        dotnet run --project ${{ env.DOCTOR_PROJECT }} -- --visual-test --output-format html --output-file visual-report.html
      continue-on-error: true

    - name: ğŸ“‹ Parse Health Report
      id: parse-report
      run: |
        $healthReport = Get-Content health-report.json | ConvertFrom-Json
        $totalChecks = $healthReport.results.Count
        $failedChecks = ($healthReport.results | Where-Object { $_.status -eq "Failed" }).Count
        $warningChecks = ($healthReport.results | Where-Object { $_.status -eq "Warning" }).Count
        $okChecks = ($healthReport.results | Where-Object { $_.status -eq "Ok" }).Count
        
        echo "total-checks=$totalChecks" >> $env:GITHUB_OUTPUT
        echo "failed-checks=$failedChecks" >> $env:GITHUB_OUTPUT  
        echo "warning-checks=$warningChecks" >> $env:GITHUB_OUTPUT
        echo "ok-checks=$okChecks" >> $env:GITHUB_OUTPUT
        echo "is-healthy=$($failedChecks -eq 0)" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: ğŸ“¤ Upload Health Report Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: health-reports-${{ github.run_number }}
        path: |
          health-report.json
          fix-report.json
          performance-report.html
          visual-report.html
        retention-days: 30

    - name: ğŸ“§ Create Issue on Failure
      if: steps.parse-report.outputs.is-healthy == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const failedChecks = ${{ steps.parse-report.outputs.failed-checks }};
          const warningChecks = ${{ steps.parse-report.outputs.warning-checks }};
          const totalChecks = ${{ steps.parse-report.outputs.total-checks }};
          
          const issueTitle = `ğŸš¨ System Health Check Failed - ${failedChecks} Critical Issues`;
          const issueBody = `
          ## ğŸ©º System Health Check Report
          
          **ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ:** ${new Date().toLocaleString('ar-EG')}
          **Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„:** #${{ github.run_number }}
          
          ### ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          - ğŸ”´ **ÙØ­ÙˆØµØ§Øª ÙØ§Ø´Ù„Ø©:** ${failedChecks}
          - ğŸŸ¡ **ØªØ­Ø°ÙŠØ±Ø§Øª:** ${warningChecks}  
          - ğŸŸ¢ **ÙØ­ÙˆØµØ§Øª Ø³Ù„ÙŠÙ…Ø©:** ${{ steps.parse-report.outputs.ok-checks }}
          - ğŸ“‹ **Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:** ${totalChecks}
          
          ### ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ÙÙŠØ¯Ø©
          - [ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ­Øµ Ø§Ù„ÙƒØ§Ù…Ù„](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          
          ### ğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
          1. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„ Ø§Ù„Ù…Ø±ÙÙ‚
          2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø±Ø¬Ø©
          3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          4. Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ù„Ù„ØªØ£ÙƒØ¯
          
          **ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ¤–**
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['bug', 'health-check', 'automated']
          });

    - name: ğŸ’¬ Post Success Comment
      if: steps.parse-report.outputs.is-healthy == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± issue Ù„Ù„ÙØ­Øµ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'health-check',
            state: 'open'
          });
          
          if (issues.data.length > 0) {
            // Ø¥ØºÙ„Ø§Ù‚ Ø¢Ø®Ø± issue Ù„Ù„ÙØ­Øµ Ø§Ù„ØµØ­ÙŠ
            const latestIssue = issues.data[0];
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: latestIssue.number,
              body: `
              ## âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø¨Ù†Ø¬Ø§Ø­!
              
              **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµÙ„Ø§Ø­:** ${new Date().toLocaleString('ar-EG')}
              **Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„:** #${{ github.run_number }}
              
              Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª ØªÙ…Øª Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø­Ø§Ù„Ø© ØµØ­ÙŠØ© Ù…Ù…ØªØ§Ø²Ø©! ğŸ‰
              
              **Ø§Ù„Ù†ØªØ§Ø¦Ø¬:**
              - âœ… **ÙØ­ÙˆØµØ§Øª Ø³Ù„ÙŠÙ…Ø©:** ${{ steps.parse-report.outputs.ok-checks }}
              - âš ï¸ **ØªØ­Ø°ÙŠØ±Ø§Øª:** ${{ steps.parse-report.outputs.warning-checks }}
              - âŒ **Ø£Ø®Ø·Ø§Ø¡:** 0
              
              ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
              `
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: latestIssue.number,
              state: 'closed'
            });
          }

    - name: ğŸ“Š Update Health Badge
      run: |
        $isHealthy = "${{ steps.parse-report.outputs.is-healthy }}"
        $badgeColor = if ($isHealthy -eq "true") { "brightgreen" } else { "red" }
        $badgeMessage = if ($isHealthy -eq "true") { "healthy" } else { "issues" }
        
        # Ø¥Ù†Ø´Ø§Ø¡ badge JSON
        $badge = @{
          schemaVersion = 1
          label = "System Health"
          message = $badgeMessage
          color = $badgeColor
          namedLogo = "github"
        } | ConvertTo-Json
        
        # Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù
        $badge | Out-File -FilePath "health-badge.json" -Encoding UTF8
      shell: pwsh

    - name: ğŸ“¤ Upload Health Badge
      uses: actions/upload-artifact@v4
      with:
        name: health-badge
        path: health-badge.json

  security-scan:
    runs-on: windows-latest
    needs: system-health-check
    
    steps:
    - name: ğŸ“¥ Checkout Repository  
      uses: actions/checkout@v4

    - name: ğŸ”’ Run Security Audit
      run: |
        dotnet list package --vulnerable --include-transitive > security-report.txt
        echo "## ğŸ”’ Security Audit Results" >> $env:GITHUB_STEP_SUMMARY
        Get-Content security-report.txt | ForEach-Object { echo "- $_" >> $env:GITHUB_STEP_SUMMARY }
      shell: pwsh

    - name: ğŸ“¤ Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.txt

  notification:
    runs-on: ubuntu-latest
    needs: [system-health-check, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“¬ Send Notification Summary
      uses: actions/github-script@v7
      with:
        script: |
          const healthResult = '${{ needs.system-health-check.result }}';
          const securityResult = '${{ needs.security-scan.result }}';
          
          const emoji = healthResult === 'success' ? 'ğŸŸ¢' : 'ğŸ”´';
          const status = healthResult === 'success' ? 'Ø³Ù„ÙŠÙ…' : 'ÙŠØ­ØªØ§Ø¬ Ø¹Ù†Ø§ÙŠØ©';
          
          console.log(`${emoji} System Health: ${status}`);
          console.log(`ğŸ”’ Security Scan: ${securityResult === 'success' ? 'Ù…ÙƒØªÙ…Ù„' : 'ÙØ´Ù„'}`);
          
          // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰ Ù‡Ù†Ø§ (Slack, Teams, Ø¥Ù„Ø®)