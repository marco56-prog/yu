<Window x:Class="AccountingSystem.WPF.Views.AdvancedReportsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="التقارير المتقدمة - النظام المحاسبي" 
        Height="900" Width="1600"
        Style="{StaticResource StandardWindow}"
        WindowState="Maximized">

    <Window.Resources>
        <!-- استخدام الأنماط الموحدة بدلاً من المحلية -->
        <Style x:Key="ModernButtonStyle" TargetType="Button" BasedOn="{StaticResource PrimaryButton}"/>
        <Style x:Key="SummaryCardStyle" TargetType="Border" BasedOn="{StaticResource StandardCard}"/>
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock" BasedOn="{StaticResource SubHeaderTextBlock}"/>
        <Style x:Key="ValueTextStyle" TargetType="TextBlock" BasedOn="{StaticResource HeaderTextBlock}">
            <Setter Property="FontSize" Value="24"/>
        </Style>
        <Style x:Key="ModernDataGridStyle" TargetType="DataGrid" BasedOn="{StaticResource StandardDataGrid}">
            <Setter Property="VirtualizingPanel.IsVirtualizing" Value="True"/>
            <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
        </Style>
    </Window.Resources>

    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Border Grid.Row="0" Background="White" Padding="30,20" Margin="0,0,0,20">
            <Border.Effect>
                <DropShadowEffect Color="Gray" BlurRadius="10" ShadowDepth="2" Opacity="0.1"/>
            </Border.Effect>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <TextBlock Text="التقارير المتقدمة" 
                               FontSize="28" FontWeight="Bold" 
                               Foreground="#2C3E50"/>
                    <TextBlock Text="تحليل شامل لأداء النشاط التجاري" 
                               FontSize="14" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               Margin="0,5,0,0"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="من:" Foreground="#34495E" 
                               VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="Medium"/>
                    <DatePicker x:Name="dpFromDate" 
                                SelectedDate="{Binding FromDate, Mode=TwoWay}"
                                Margin="0,0,15,0" Width="130"/>
                    <TextBlock Text="إلى:" Foreground="#34495E" 
                               VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="Medium"/>
                    <DatePicker x:Name="dpToDate" 
                                SelectedDate="{Binding ToDate, Mode=TwoWay}"
                                Margin="0,0,15,0" Width="130"/>
                    <Button Content="تحديث البيانات" 
                            Style="{StaticResource ModernButtonStyle}"
                            Background="#27AE60"
                            Command="{Binding RefreshDataCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Lightweight status indicator (non-blocking) -->
        <TextBlock x:Name="lblStatus" Grid.Row="0" HorizontalAlignment="Right" VerticalAlignment="Top"
                   Margin="0,10,20,0" FontSize="12" Foreground="#E74C3C" Visibility="Collapsed"/>

        <!-- Summary Cards Section -->
        <UniformGrid Grid.Row="1" Columns="4" Margin="20,0,20,20">
            <!-- Total Sales Card -->
            <Border Style="{StaticResource SummaryCardStyle}">
                <StackPanel>
                    <TextBlock Text="إجمالي المبيعات" Style="{StaticResource HeaderTextStyle}"/>
                    <TextBlock Text="{Binding TotalSales, StringFormat='{}{0:N2} ج.م'}" 
                               Style="{StaticResource ValueTextStyle}"
                               Foreground="#27AE60"/>
                    <TextBlock Text="{Binding SalesGrowthText}" 
                               FontSize="12" 
                               Foreground="#95A5A6" 
                               Margin="0,5,0,0"/>
                </StackPanel>
            </Border>
            
            <!-- Total Purchases Card -->
            <Border Style="{StaticResource SummaryCardStyle}">
                <StackPanel>
                    <TextBlock Text="إجمالي المشتريات" Style="{StaticResource HeaderTextStyle}"/>
                    <TextBlock Text="{Binding TotalPurchases, StringFormat='{}{0:N2} ج.م'}" 
                               Style="{StaticResource ValueTextStyle}"
                               Foreground="#E74C3C"/>
                    <TextBlock Text="{Binding PurchasesGrowthText}" 
                               FontSize="12" 
                               Foreground="#95A5A6" 
                               Margin="0,5,0,0"/>
                </StackPanel>
            </Border>
            
            <!-- Net Profit Card -->
            <Border Style="{StaticResource SummaryCardStyle}">
                <StackPanel>
                    <TextBlock Text="صافي الربح" Style="{StaticResource HeaderTextStyle}"/>
                    <TextBlock Text="{Binding NetProfit, StringFormat='{}{0:N2} ج.م'}" 
                               Style="{StaticResource ValueTextStyle}"
                               Foreground="#F39C12"/>
                    <TextBlock Text="{Binding ProfitMarginText}" 
                               FontSize="12" 
                               Foreground="#95A5A6" 
                               Margin="0,5,0,0"/>
                </StackPanel>
            </Border>
            
            <!-- Total Invoices Card -->
            <Border Style="{StaticResource SummaryCardStyle}">
                <StackPanel>
                    <TextBlock Text="إجمالي الفواتير" Style="{StaticResource HeaderTextStyle}"/>
                    <TextBlock Text="{Binding TotalInvoices, StringFormat='{}{0:N0} فاتورة'}" 
                               Style="{StaticResource ValueTextStyle}"
                               Foreground="#9B59B6"/>
                    <TextBlock Text="{Binding InvoicesCountText}" 
                               FontSize="12" 
                               Foreground="#95A5A6" 
                               Margin="0,5,0,0"/>
                </StackPanel>
            </Border>
        </UniformGrid>

        <!-- Reports Tabs Section -->
        <Border Grid.Row="2" Background="White" Margin="20,0,20,20" CornerRadius="10">
            <Border.Effect>
                <DropShadowEffect Color="Gray" BlurRadius="10" ShadowDepth="2" Opacity="0.1"/>
            </Border.Effect>
            
            <TabControl Background="Transparent" BorderThickness="0" Padding="20">
                <!-- Sales Report Tab -->
                <TabItem Header="تقرير المبيعات">
                    <Grid Margin="0,20,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="220"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Sales Controls -->
                        <Border Grid.Row="0" Background="#F8F9FA" Padding="15" CornerRadius="8" Margin="0,0,0,15">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="نوع التقرير:" VerticalAlignment="Center" Margin="0,0,15,0" FontWeight="Medium"/>
                                <ComboBox x:Name="cmbSalesReportType" 
                                          Width="200" 
                                          SelectedIndex="{Binding SelectedSalesReportType, Mode=TwoWay}"
                                          ItemsSource="{Binding SalesReportTypes}"
                                          Padding="10,8"/>
                                <Button Content="إنتاج التقرير" 
                                        Style="{StaticResource ModernButtonStyle}"
                                        Command="{Binding GenerateSalesReportCommand}"
                                        Margin="15,0,0,0"/>
                                <Button Content="تصدير إلى CSV" 
                                        Style="{StaticResource ModernButtonStyle}"
                                        Background="#16A085"
                                        Command="{Binding ExportSalesCommand}"
                                        Margin="10,0,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Sales Chart Placeholder -->
                        <Border Grid.Row="1" Background="LightGray" CornerRadius="5">
                            <TextBlock Text="مخطط المبيعات سيتم إضافته لاحقاً" 
                                     HorizontalAlignment="Center" VerticalAlignment="Center"
                                     FontSize="16" Foreground="Gray"/>
                        </Border>

                        <!-- Sales Data Grid -->
                        <DataGrid Grid.Row="2" 
                                  ItemsSource="{Binding SalesReportItems}"
                                  AutoGenerateColumns="False" 
                                  CanUserAddRows="False" 
                                  CanUserDeleteRows="False"
                                  IsReadOnly="True"
                                  Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="رقم الفاتورة" Binding="{Binding InvoiceNumber}" Width="120"/>
                                <DataGridTextColumn Header="التاريخ" Binding="{Binding InvoiceDate, StringFormat=yyyy/MM/dd}" Width="100"/>
                                <DataGridTextColumn Header="العميل" Binding="{Binding CustomerName}" Width="200"/>
                                <DataGridTextColumn Header="المجموع الفرعي" Binding="{Binding SubTotal, StringFormat=N2}" Width="130"/>
                                <DataGridTextColumn Header="الضريبة" Binding="{Binding TaxAmount, StringFormat=N2}" Width="100"/>
                                <DataGridTextColumn Header="الخصم" Binding="{Binding DiscountAmount, StringFormat=N2}" Width="100"/>
                                <DataGridTextColumn Header="الإجمالي" Binding="{Binding NetTotal, StringFormat=N2}" Width="130"/>
                                <DataGridTextColumn Header="عدد الأصناف" Binding="{Binding ItemsCount}" Width="100"/>
                                <DataGridTextColumn Header="حالة الدفع" Binding="{Binding PaymentStatus}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <!-- Inventory Report Tab -->
                <TabItem Header="تقرير المخزون">
                    <Grid Margin="0,20,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Inventory Data Grid -->
                        <DataGrid Grid.Row="0" 
                                  ItemsSource="{Binding InventoryReportItems}"
                                  AutoGenerateColumns="False" 
                                  CanUserAddRows="False" 
                                  CanUserDeleteRows="False"
                                  IsReadOnly="True"
                                  Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="كود المنتج" Binding="{Binding ProductCode}" Width="120"/>
                                <DataGridTextColumn Header="اسم المنتج" Binding="{Binding ProductName}" Width="250"/>
                                <DataGridTextColumn Header="الفئة" Binding="{Binding CategoryName}" Width="120"/>
                                <DataGridTextColumn Header="الوحدة" Binding="{Binding UnitName}" Width="80"/>
                                <DataGridTextColumn Header="الكمية الحالية" Binding="{Binding CurrentStock, StringFormat=N2}" Width="120"/>
                                <DataGridTextColumn Header="الحد الأدنى" Binding="{Binding MinimumStock, StringFormat=N2}" Width="100"/>
                                <DataGridTextColumn Header="سعر الشراء" Binding="{Binding PurchasePrice, StringFormat=N2}" Width="120"/>
                                <DataGridTextColumn Header="سعر البيع" Binding="{Binding SalePrice, StringFormat=N2}" Width="120"/>
                                <DataGridTextColumn Header="قيمة المخزون" Binding="{Binding StockValue, StringFormat=N2}" Width="130"/>
                                <DataGridTextColumn Header="الحالة" Binding="{Binding Status}" Width="120">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <Trigger Property="Text" Value="نفدت الكمية">
                                                    <Setter Property="Foreground" Value="#E74C3C"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </Trigger>
                                                <Trigger Property="Text" Value="كمية منخفضة">
                                                    <Setter Property="Foreground" Value="#F39C12"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </Trigger>
                                                <Trigger Property="Text" Value="كمية جيدة">
                                                    <Setter Property="Foreground" Value="#27AE60"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <!-- Profit Analysis Tab -->
                <TabItem Header="تحليل الأرباح">
                    <Grid Margin="0,20,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="220"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Profit Chart Placeholder -->
                        <Border Grid.Row="0" Background="LightGray" CornerRadius="5">
                            <TextBlock Text="مخطط الأرباح سيتم إضافته لاحقاً" 
                                     HorizontalAlignment="Center" VerticalAlignment="Center"
                                     FontSize="16" Foreground="Gray"/>
                        </Border>

                        <!-- Profit Data Grid -->
                        <DataGrid Grid.Row="1" 
                                  ItemsSource="{Binding ProfitReportItems}"
                                  AutoGenerateColumns="False" 
                                  CanUserAddRows="False" 
                                  CanUserDeleteRows="False"
                                  IsReadOnly="True"
                                  Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="التاريخ" Binding="{Binding Date, StringFormat=yyyy/MM/dd}" Width="120"/>
                                <DataGridTextColumn Header="الفترة" Binding="{Binding Period}" Width="120"/>
                                <DataGridTextColumn Header="الإيرادات" Binding="{Binding Revenue, StringFormat=N2}" Width="150"/>
                                <DataGridTextColumn Header="تكلفة البضاعة" Binding="{Binding CostOfGoodsSold, StringFormat=N2}" Width="150"/>
                                <DataGridTextColumn Header="إجمالي الربح" Binding="{Binding GrossProfit, StringFormat=N2}" Width="150"/>
                                <DataGridTextColumn Header="المصروفات" Binding="{Binding Expenses, StringFormat=N2}" Width="130"/>
                                <DataGridTextColumn Header="صافي الربح" Binding="{Binding NetProfit, StringFormat=N2}" Width="150"/>
                                <DataGridTextColumn Header="هامش الربح %" Binding="{Binding ProfitMargin, StringFormat=N2}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <!-- Top Products Tab -->
                <TabItem Header="أفضل المنتجات">
                    <Grid Margin="0,20,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Top Products Header -->
                        <Border Grid.Row="0" Background="#F8F9FA" Padding="15" CornerRadius="8" Margin="0,0,0,15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" 
                                           Text="أفضل المنتجات أداءً حسب المبيعات والأرباح" 
                                           FontWeight="SemiBold"
                                           FontSize="16"
                                           VerticalAlignment="Center"
                                           Foreground="#2C3E50"/>
                                <Button Grid.Column="1" 
                                        Content="تصدير إلى CSV" 
                                        Style="{StaticResource ModernButtonStyle}"
                                        Background="#16A085"
                                        Command="{Binding ExportTopProductsCommand}"/>
                            </Grid>
                        </Border>
                        
                        <!-- Top Products Data Grid -->
                        <DataGrid Grid.Row="1" 
                                  ItemsSource="{Binding TopProducts}"
                                  AutoGenerateColumns="False" 
                                  CanUserAddRows="False" 
                                  CanUserDeleteRows="False"
                                  IsReadOnly="True"
                                  Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="الترتيب" Binding="{Binding Rank}" Width="80"/>
                                <DataGridTextColumn Header="كود المنتج" Binding="{Binding ProductCode}" Width="120"/>
                                <DataGridTextColumn Header="اسم المنتج" Binding="{Binding ProductName}" Width="300"/>
                                <DataGridTextColumn Header="إجمالي الكمية المباعة" Binding="{Binding TotalQuantitySold, StringFormat=N2}" Width="160"/>
                                <DataGridTextColumn Header="إجمالي المبيعات" Binding="{Binding TotalSalesValue, StringFormat=N2}" Width="150"/>
                                <DataGridTextColumn Header="إجمالي الربح" Binding="{Binding TotalProfit, StringFormat=N2}" Width="130"/>
                                <DataGridTextColumn Header="عدد مرات البيع" Binding="{Binding SalesTransactions}" Width="140"/>
                                <DataGridTextColumn Header="متوسط السعر" Binding="{Binding AveragePrice, StringFormat=N2}" Width="120"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>

        <!-- Action Buttons Footer -->
        <Border Grid.Row="3" Background="White" Padding="20,15" Margin="20,0,20,20" CornerRadius="10">
            <Border.Effect>
                <DropShadowEffect Color="Gray" BlurRadius="10" ShadowDepth="2" Opacity="0.1"/>
            </Border.Effect>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="تصدير جميع التقارير" 
                            Style="{StaticResource ModernButtonStyle}"
                            Background="#16A085"
                            Command="{Binding ExportAllReportsCommand}"/>
                    <Button Content="إعادة تحميل البيانات" 
                            Style="{StaticResource ModernButtonStyle}"
                            Background="#E67E22"
                            Command="{Binding RefreshAllDataCommand}"/>
                </StackPanel>

                <TextBlock Grid.Column="1" 
                           Text="{Binding LastUpdateText}" 
                           VerticalAlignment="Center" 
                           HorizontalAlignment="Center"
                           FontSize="12"
                           Foreground="#95A5A6"/>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="طباعة التقارير" 
                            Style="{StaticResource ModernButtonStyle}"
                            Background="#34495E"
                            Command="{Binding PrintReportsCommand}"/>
                    <Button Content="إرسال بالبريد" 
                            Style="{StaticResource ModernButtonStyle}"
                            Background="#9B59B6"
                            Command="{Binding EmailReportsCommand}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
