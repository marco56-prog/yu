<Window x:Class="AccountingSystem.WPF.Views.CashBoxWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:AccountingSystem.WPF.Converters"
        Title="إدارة الخزنة"
        Height="650" Width="1000"
        Style="{StaticResource StandardWindow}"
        WindowState="Maximized">

    <Window.Resources>
        <conv:TransactionTypeToArabicConverter x:Key="TypeToArabic"/>
        <conv:AmountBrushByTypeConverter x:Key="AmountBrush"/>
        
        <!-- استخدام الأنماط الموحدة -->
        <Style x:Key="IncomeStyle" TargetType="TextBlock" BasedOn="{StaticResource BodyTextBlock}">
            <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <Style x:Key="ExpenseStyle" TargetType="TextBlock" BasedOn="{StaticResource BodyTextBlock}">
            <Setter Property="Foreground" Value="{StaticResource DangerBrush}"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
    </Window.Resources>

    <Grid Style="{StaticResource MainWindowLayout}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- العنوان -->
        <Border Grid.Row="0" Style="{StaticResource TitleBarLayout}">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <TextBlock Text="{StaticResource CashIcon}" 
                           FontSize="24" 
                           VerticalAlignment="Center" 
                           Margin="{StaticResource SmallMargin}"/>
                <TextBlock Text="إدارة الخزنة" 
                           Style="{StaticResource HeaderTextBlock}"
                           Foreground="{StaticResource TextOnPrimaryBrush}"/>
            </StackPanel>
        </Border>

        <!-- معلومات الخزنة -->
        <Border Grid.Row="1" Style="{StaticResource StandardCard}" Margin="{StaticResource MediumMargin}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- اختيار الخزنة -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="الخزنة:" FontWeight="Bold" FontSize="{StaticResource FontSizeMedium}"/>
                    <ComboBox ItemsSource="{Binding CashBoxes}"
                              SelectedItem="{Binding SelectedCashBox, Mode=TwoWay}"
                              DisplayMemberPath="CashBoxName"
                              FontSize="{StaticResource FontSizeNormal}" Height="30"/>
                </StackPanel>

                <!-- الرصيد الحالي -->
                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                    <TextBlock Text="الرصيد الحالي:" FontWeight="Bold" FontSize="{StaticResource FontSizeMedium}"/>
                    <TextBlock Text="{Binding CurrentBalanceDisplay}"
                               FontSize="{StaticResource FontSizeLarge}" FontWeight="Bold" Foreground="{StaticResource PrimaryColor}"/>
                </StackPanel>

                <!-- تاريخ آخر حركة -->
                <StackPanel Grid.Column="2" HorizontalAlignment="Left">
                    <TextBlock Text="آخر حركة:" FontWeight="Bold" FontSize="{StaticResource FontSizeMedium}"/>
                    <TextBlock Text="{Binding LastTransactionDisplay}" FontSize="{StaticResource FontSizeSmall}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- أزرار العمليات السريعة -->
        <StackPanel Grid.Row="2" Orientation="Horizontal"
                    HorizontalAlignment="Center" Margin="10">
            <Button Content="إضافة دخل" Style="{StaticResource SuccessButton}"
                    Command="{Binding AddIncomeCommand}"/>
            <Button Content="إضافة مصروف" Style="{StaticResource DangerButton}"
                    Command="{Binding AddExpenseCommand}"/>
            <Button Content="تحويل بين الخزائن" Style="{StaticResource WarningButton}"
                    Command="{Binding TransferCommand}"/>
            <Button Content="تحديث" Style="{StaticResource SecondaryButton}"
                    Command="{Binding RefreshCommand}"/>
        </StackPanel>

        <!-- جدول حركات الخزنة -->
        <Grid Grid.Row="3" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- فلاتر البحث -->
            <Border Grid.Row="0" BorderBrush="{StaticResource BorderColor}" BorderThickness="1"
                    CornerRadius="5" Padding="10" Margin="0,0,0,10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Margin="5">
                        <TextBlock Text="من تاريخ:" FontWeight="Bold"/>
                        <DatePicker SelectedDate="{Binding FromDate, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Margin="5">
                        <TextBlock Text="إلى تاريخ:" FontWeight="Bold"/>
                        <DatePicker SelectedDate="{Binding ToDate, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Margin="5">
                        <TextBlock Text="نوع الحركة:" FontWeight="Bold"/>
                        <ComboBox ItemsSource="{Binding TransactionTypeOptions}"
                                  SelectedItem="{Binding SelectedTransactionType, Mode=TwoWay}"/>
                    </StackPanel>

                    <Button Grid.Column="3" Content="فلترة"
                            Style="{StaticResource ButtonStyle}" VerticalAlignment="Bottom"
                            Command="{Binding FilterCommand}"/>
                </Grid>
            </Border>

            <!-- جدول الحركات -->
            <DataGrid Grid.Row="1"
                      ItemsSource="{Binding Transactions}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      GridLinesVisibility="Horizontal"
                      HeadersVisibility="Column"
                      SelectionMode="Single"
                      EnableRowVirtualization="True"
                      EnableColumnVirtualization="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="رقم الحركة" Binding="{Binding TransactionNumber}" Width="120" IsReadOnly="True"/>
                    <DataGridTextColumn Header="التاريخ" Binding="{Binding TransactionDate, StringFormat=yyyy-MM-dd HH:mm}" Width="140" IsReadOnly="True"/>
                    <DataGridTextColumn Header="نوع الحركة" Width="100" IsReadOnly="True">
                        <DataGridTextColumn.Binding>
                            <Binding Path="TransactionType" Converter="{StaticResource TypeToArabic}"/>
                        </DataGridTextColumn.Binding>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="المبلغ" Width="120" IsReadOnly="True">
                        <DataGridTextColumn.Binding>
                            <Binding Path="Amount" StringFormat="{}{0:N2} ج.م"/>
                        </DataGridTextColumn.Binding>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{Binding TransactionType, Converter={StaticResource AmountBrush}}"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="الوصف" Binding="{Binding Description}" Width="*" IsReadOnly="True"/>
                    <DataGridTextColumn Header="المرجع" Binding="{Binding ReferenceType}" Width="100" IsReadOnly="True"/>
                    <DataGridTextColumn Header="رقم المرجع" Binding="{Binding ReferenceId}" Width="100" IsReadOnly="True"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <!-- شريط الحالة -->
        <StatusBar Grid.Row="4" Style="{StaticResource ModernStatusBar}">
            <StatusBarItem>
                <TextBlock Text="{Binding Status}" />
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Center">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="إجمالي الدخل: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding TotalIncome, StringFormat={}{0:N2}}" Foreground="{StaticResource SuccessColor}" FontWeight="Bold"/>
                    <TextBlock Text=" | إجمالي المصروف: " FontWeight="Bold" Margin="10,0,0,0"/>
                    <TextBlock Text="{Binding TotalExpense, StringFormat={}{0:N2}}" Foreground="{StaticResource DangerColor}" FontWeight="Bold"/>
                </StackPanel>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock Text="{Binding CountDisplay}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
