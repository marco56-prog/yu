<Window x:Class="AccountingSystem.WPF.Views.ModernItemEntryDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="إدخال/تعديل صنف احترافي"
        Height="580" Width="900" MinHeight="520" MinWidth="800"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        FlowDirection="RightToLeft"
        FontFamily="Segoe UI, Tahoma"
        FontSize="{DynamicResource FontSizeSmall}"
        Background="{DynamicResource BackgroundBrush}"
        PreviewKeyDown="Window_PreviewKeyDown"
        Loaded="Window_Loaded"
        FocusManager.FocusedElement="{Binding ElementName=cmbProduct}">

    <!-- ================= اختصارات الكيبورد ================= -->
    <Window.InputBindings>
        <KeyBinding Key="F1" Command="{Binding SearchProductCommand}"/>
        <KeyBinding Key="F5" Command="{Binding PreviousItemCommand}"/>
        <KeyBinding Key="F6" Command="{Binding NextItemCommand}"/>
        <KeyBinding Modifiers="Control" Key="S" Command="{Binding SaveAndAddCommand}"/>
        <KeyBinding Modifiers="Control+Shift" Key="S" Command="{Binding SaveAndCloseCommand}"/>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}"/>
        <KeyBinding Key="Enter" Command="{Binding SmartEnterCommand}"/>
    </Window.InputBindings>

    <!-- ================= موارد محلية وأنماط ================= -->
    <Window.Resources>
        
        <!-- أنماط للحقول الذكية -->
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="{DynamicResource FontSizeNormal}"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
        </Style>

        <Style x:Key="SmartTextBoxStyle" TargetType="TextBox">
            <Setter Property="Height" Value="32"/>
            <Setter Property="FontSize" Value="{DynamicResource FontSizeSmall}"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Style.Triggers>
                <Trigger Property="IsFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                    <Setter Property="BorderThickness" Value="2"/>
                </Trigger>
                <Trigger Property="IsReadOnly" Value="True">
                    <Setter Property="Background" Value="{DynamicResource DisabledBrush}"/>
                    <Setter Property="Foreground" Value="{DynamicResource MutedBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="NumericTextBoxStyle" TargetType="TextBox" BasedOn="{StaticResource SmartTextBoxStyle}">
            <Setter Property="TextAlignment" Value="Center"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
        </Style>

        <Style x:Key="SmartComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Height" Value="32"/>
            <Setter Property="FontSize" Value="{DynamicResource FontSizeSmall}"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Style.Triggers>
                <Trigger Property="IsFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                    <Setter Property="BorderThickness" Value="2"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- شارة معلومات -->
        <Style x:Key="InfoBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Background" Value="{DynamicResource InfoBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource InfoBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- تحذير المخزون -->
        <Style x:Key="StockWarningStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="6,3"/>
            <Setter Property="Background" Value="{DynamicResource DangerBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource DangerBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Opacity" Value="0.9"/>
        </Style>

        <!-- تلميح سريع -->
        <Style x:Key="QuickHint" TargetType="TextBlock">
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Foreground" Value="{DynamicResource MutedBrush}"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- أيقونة حالة -->
        <Style x:Key="StatusIcon" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
        </Style>

        <!-- تحويلة وحدة معقدة -->
        <DataTemplate x:Key="UnitConversionTemplate">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding UnitName}" FontWeight="Bold"/>
                <TextBlock Text=" (1 = " Margin="4,0,0,0"/>
                <TextBlock Text="{Binding ConversionFactor}"/>
                <TextBlock Text=" من الوحدة الأساسية)" Margin="0,0,4,0"/>
            </StackPanel>
        </DataTemplate>

    </Window.Resources>

    <!-- ================= تخطيط النافذة الرئيسي ================= -->
    <Grid Margin="16" Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ========== العنوان والحالة ========== -->
        <Border Grid.Row="0" 
                Background="{DynamicResource PrimaryBrush}" 
                CornerRadius="8,8,0,0" 
                Padding="16,12" 
                Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" 
                           Text="إدخال صنف ذكي" 
                           FontSize="{DynamicResource FontSizeLarge}" 
                           FontWeight="Bold" 
                           Foreground="White" 
                           VerticalAlignment="Center"/>

                <!-- معلومات المخزون -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                    <TextBlock Text="المتاح:" Foreground="White" Margin="0,0,4,0"/>
                    <Border Background="White" 
                            CornerRadius="4" 
                            Padding="6,2">
                        <TextBlock x:Name="lblAvailableStock" 
                                   Text="0.00" 
                                   FontWeight="Bold" 
                                   Foreground="{DynamicResource AccentBrush}"/>
                    </Border>
                </StackPanel>

                <!-- حالة التحقق -->
                <Border Grid.Column="2" 
                        x:Name="brdValidationStatus"
                        Background="{DynamicResource SuccessBrush}" 
                        CornerRadius="20" 
                        Width="40" Height="40" 
                        VerticalAlignment="Center">
                    <TextBlock x:Name="lblValidationIcon" 
                               Text="✓" 
                               Style="{StaticResource StatusIcon}" 
                               Foreground="White"/>
                </Border>
            </Grid>
        </Border>

        <!-- ========== منطقة الإدخال الرئيسية ========== -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- العمود الأيمن: المنتج والوحدة والكميات -->
                <StackPanel Grid.Column="0">
                    
                    <!-- المنتج + بحث -->
                    <TextBlock Text="المنتج:" Style="{StaticResource HeaderTextStyle}"/>
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="36"/>
                        </Grid.ColumnDefinitions>
                        
                        <ComboBox x:Name="cmbProduct" 
                                  Grid.Column="0"
                                  Style="{StaticResource SmartComboBoxStyle}"
                                  DisplayMemberPath="ProductName"
                                  IsEditable="True"
                                  TabIndex="1"
                                  SelectionChanged="cmbProduct_SelectionChanged"
                                  PreviewTextInput="cmbProduct_PreviewTextInput"
                                  DropDownOpened="cmbProduct_DropDownOpened"
                                  KeyDown="cmbProduct_KeyDown"/>
                        
                        <Button Grid.Column="1" 
                                x:Name="btnSearchProduct"
                                Content="🔎" 
                                Width="32" Height="32" 
                                Margin="4,0,0,0"
                                Background="{DynamicResource AccentBrush}"
                                Foreground="White"
                                BorderThickness="0"
                                FontSize="12"
                                Cursor="Hand"
                                Click="btnSearchProduct_Click">
                            <Button.ToolTip>
                                <ToolTip Content="F1 - بحث في المنتجات"/>
                            </Button.ToolTip>
                        </Button>
                    </Grid>

                    <!-- الوحدة + تحويل -->
                    <TextBlock Text="الوحدة:" Style="{StaticResource HeaderTextStyle}"/>
                    <ComboBox x:Name="cmbUnit" 
                              Style="{StaticResource SmartComboBoxStyle}"
                              ItemTemplate="{StaticResource UnitConversionTemplate}"
                              TabIndex="2"
                              SelectionChanged="cmbUnit_SelectionChanged"
                              Margin="0,0,0,12"/>

                    <!-- الكميات الذكية -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- الكمية الكلية -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="الكمية الكلية:" Style="{StaticResource HeaderTextStyle}"/>
                        <TextBox Grid.Row="1" Grid.Column="0" 
                                 x:Name="txtWholeQty"
                                 Style="{StaticResource NumericTextBoxStyle}"
                                 Text="1"
                                 TabIndex="3"
                                 TextChanged="txtWholeQty_TextChanged"/>

                        <!-- الكمية الجزئية -->
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="الكمية الجزئية:" Style="{StaticResource HeaderTextStyle}"/>
                        <TextBox Grid.Row="1" Grid.Column="2" 
                                 x:Name="txtPartQty"
                                 Style="{StaticResource NumericTextBoxStyle}"
                                 Text="0"
                                 TabIndex="4"
                                 TextChanged="txtPartQty_TextChanged"/>

                        <!-- معامل التحويل -->
                        <TextBlock Grid.Row="2" Grid.ColumnSpan="3" 
                                   Text="معامل التحويل:" 
                                   Style="{StaticResource HeaderTextStyle}" 
                                   Margin="0,8,0,0"/>
                        <Border Grid.Row="3" Grid.ColumnSpan="3" Style="{StaticResource InfoBadge}">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="1 وحدة أساسية = " Foreground="White"/>
                                <TextBlock x:Name="lblConversionFactor" Text="1.00" FontWeight="Bold" Foreground="White"/>
                                <TextBlock Text=" من الوحدة المختارة" Foreground="White"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- الأسعار الذكية -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- السعر الكلي -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="السعر الكلي:" Style="{StaticResource HeaderTextStyle}"/>
                        <TextBox Grid.Row="1" Grid.Column="0" 
                                 x:Name="txtWholePrice"
                                 Style="{StaticResource NumericTextBoxStyle}"
                                 Text="0.00"
                                 TabIndex="5"
                                 TextChanged="txtWholePrice_TextChanged"/>

                        <!-- السعر الجزئي -->
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="السعر الجزئي:" Style="{StaticResource HeaderTextStyle}"/>
                        <TextBox Grid.Row="1" Grid.Column="2" 
                                 x:Name="txtPartPrice"
                                 Style="{StaticResource NumericTextBoxStyle}"
                                 Text="0.00"
                                 TabIndex="6"
                                 TextChanged="txtPartPrice_TextChanged"/>

                        <!-- مؤشر السعر التلقائي -->
                        <Border Grid.Row="2" Grid.ColumnSpan="3" 
                                x:Name="brdAutoPriceIndicator"
                                Style="{StaticResource InfoBadge}" 
                                Margin="0,4,0,0"
                                Visibility="Collapsed">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="🔄" Margin="0,0,4,0" Foreground="White"/>
                                <TextBlock Text="تم جلب السعر تلقائياً من:" Foreground="White"/>
                                <TextBlock x:Name="lblPriceSource" Text="المنتج" FontWeight="Bold" Foreground="White" Margin="4,0,0,0"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- الخصم -->
                    <TextBlock Text="الخصم:" Style="{StaticResource HeaderTextStyle}"/>
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="8"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBox Grid.Column="0" 
                                 x:Name="txtDiscount"
                                 Style="{StaticResource NumericTextBoxStyle}"
                                 Text="0.00"
                                 TabIndex="7"
                                 TextChanged="txtDiscount_TextChanged"/>
                        
                        <ComboBox Grid.Column="2" 
                                  x:Name="cmbDiscountType"
                                  Style="{StaticResource SmartComboBoxStyle}"
                                  SelectedIndex="0"
                                  SelectionChanged="cmbDiscountType_SelectionChanged">
                            <ComboBoxItem Content="ج.م"/>
                            <ComboBoxItem Content="%"/>
                        </ComboBox>
                    </Grid>
                </StackPanel>

                <!-- فاصل -->
                <Rectangle Grid.Column="1" 
                          Fill="{DynamicResource BorderBrush}" 
                          Width="1" 
                          HorizontalAlignment="Center" 
                          Margin="0,8"/>

                <!-- العمود الأيسر: المعلومات والملخص -->
                <StackPanel Grid.Column="2">
                    
                    <!-- معلومات المنتج -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            BorderBrush="{DynamicResource BorderBrush}" 
                            BorderThickness="1" 
                            CornerRadius="6" 
                            Padding="12" 
                            Margin="0,0,0,12">
                        <StackPanel>
                            <TextBlock Text="معلومات المنتج" 
                                       Style="{StaticResource HeaderTextStyle}" 
                                       HorizontalAlignment="Center" 
                                       Margin="0,0,0,8"/>
                            
                            <TextBlock Text="الاسم:" FontWeight="Bold" Margin="0,0,0,2"/>
                            <TextBlock x:Name="lblProductName" Text="-" TextWrapping="Wrap" Margin="0,0,0,6"/>
                            
                            <TextBlock Text="الكود:" FontWeight="Bold" Margin="0,0,0,2"/>
                            <TextBlock x:Name="lblProductCode" Text="-" Margin="0,0,0,6"/>
                            
                            <TextBlock Text="المخزون الحالي:" FontWeight="Bold" Margin="0,0,0,2"/>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock x:Name="lblCurrentStock" Text="0.00" Margin="0,0,4,0"/>
                                <TextBlock x:Name="lblStockUnit" Text="وحدة" Foreground="{DynamicResource MutedBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- آخر 3 أسعار -->
                    <Border x:Name="brdLastPrices"
                            Background="{DynamicResource SurfaceBrush}" 
                            BorderBrush="{DynamicResource BorderBrush}" 
                            BorderThickness="1" 
                            CornerRadius="6" 
                            Padding="12" 
                            Margin="0,0,0,12"
                            Visibility="Collapsed">
                        <StackPanel>
                            <TextBlock Text="آخر 3 أسعار" 
                                       Style="{StaticResource HeaderTextStyle}" 
                                       HorizontalAlignment="Center" 
                                       Margin="0,0,0,8"/>
                            
                            <ItemsControl x:Name="icLastPrices">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource InfoBrush}" 
                                                CornerRadius="4" 
                                                Padding="6,3" 
                                                Margin="0,1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Price}" FontWeight="Bold" Foreground="White"/>
                                                <TextBlock Text=" ج.م في " Foreground="White" Margin="4,0"/>
                                                <TextBlock Text="{Binding Date}" Foreground="White"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <!-- تحذير المخزون -->
                    <Border x:Name="brdStockWarning" 
                            Style="{StaticResource StockWarningStyle}"
                            Margin="0,0,0,12"
                            Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="⚠️" Margin="0,0,4,0" Foreground="White"/>
                            <TextBlock x:Name="lblStockWarning" Text="تحذير مخزون" Foreground="White" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>

                    <!-- ملخص الإجمالي -->
                    <Border Background="{DynamicResource SuccessBrush}" 
                            CornerRadius="8" 
                            Padding="16" 
                            Margin="0,0,0,12">
                        <StackPanel>
                            <TextBlock Text="إجمالي السطر" 
                                       FontSize="{DynamicResource FontSizeNormal}" 
                                       FontWeight="Bold" 
                                       Foreground="White" 
                                       HorizontalAlignment="Center" 
                                       Margin="0,0,0,8"/>
                            
                            <TextBlock x:Name="lblLineTotal" 
                                       Text="0.00 ج.م" 
                                       FontSize="{DynamicResource FontSizeLarge}" 
                                       FontWeight="Bold" 
                                       Foreground="White" 
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- مؤشر الحالة -->
                    <Border x:Name="brdStatusIndicator"
                            Background="{DynamicResource InfoBrush}" 
                            CornerRadius="6" 
                            Padding="8">
                        <TextBlock x:Name="lblStatusMessage" 
                                   Text="جاهز للإدخال" 
                                   Foreground="White" 
                                   FontWeight="Bold" 
                                   HorizontalAlignment="Center"/>
                    </Border>
                </StackPanel>
            </Grid>
        </ScrollViewer>

        <!-- ========== أزرار التحكم ========== -->
        <Border Grid.Row="2" 
                Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" 
                BorderThickness="0,1,0,0" 
                Padding="16,12" 
                Margin="0,8,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- أزرار التنقل -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button x:Name="btnPrevious" 
                            Content="◀ السابق" 
                            Style="{DynamicResource SecondaryButtonStyle}" 
                            IsTabStop="False"
                            Click="btnPrevious_Click"
                            Margin="0,0,8,0">
                        <Button.ToolTip>
                            <ToolTip Content="F5 - الصنف السابق"/>
                        </Button.ToolTip>
                    </Button>
                    
                    <Button x:Name="btnNext" 
                            Content="التالي ▶" 
                            Style="{DynamicResource SecondaryButtonStyle}" 
                            IsTabStop="False"
                            Click="btnNext_Click">
                        <Button.ToolTip>
                            <ToolTip Content="F6 - الصنف التالي"/>
                        </Button.ToolTip>
                    </Button>
                </StackPanel>

                <!-- معلومات سريعة -->
                <StackPanel Grid.Column="1" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Center" 
                            VerticalAlignment="Center">
                    <TextBlock Text="Enter للحقل التالي" Style="{StaticResource QuickHint}"/>
                    <TextBlock Text="•" Style="{StaticResource QuickHint}"/>
                    <TextBlock Text="F1 بحث" Style="{StaticResource QuickHint}"/>
                    <TextBlock Text="•" Style="{StaticResource QuickHint}"/>
                    <TextBlock Text="Ctrl+S حفظ وإضافة" Style="{StaticResource QuickHint}"/>
                </StackPanel>

                <!-- أزرار الحفظ والإلغاء -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button x:Name="btnSaveAndAdd" 
                            Content="✅ حفظ وإضافة" 
                            Style="{DynamicResource PrimaryButtonStyle}" 
                            TabIndex="8"
                            Click="btnSaveAndAdd_Click" 
                            Margin="0,0,8,0">
                        <Button.ToolTip>
                            <ToolTip Content="Ctrl+S - حفظ السطر وفتح نافذة جديدة"/>
                        </Button.ToolTip>
                    </Button>
                    
                    <Button x:Name="btnSaveAndClose" 
                            Content="✅ حفظ وإغلاق" 
                            Style="{DynamicResource SecondaryButtonStyle}" 
                            TabIndex="9"
                            Click="btnSaveAndClose_Click" 
                            Margin="0,0,8,0">
                        <Button.ToolTip>
                            <ToolTip Content="Ctrl+Shift+S - حفظ السطر وإغلاق النافذة"/>
                        </Button.ToolTip>
                    </Button>
                    
                    <Button x:Name="btnCancel" 
                            Content="✗ إلغاء" 
                            Style="{DynamicResource DangerButtonStyle}" 
                            TabIndex="10"
                            Click="btnCancel_Click">
                        <Button.ToolTip>
                            <ToolTip Content="Escape - إلغاء وإغلاق"/>
                        </Button.ToolTip>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ========== طبقة التحميل ========== -->
        <Grid x:Name="BusyOverlay" 
              Grid.RowSpan="3"
              Visibility="Collapsed" 
              Background="#80000000">
            <Border Background="{DynamicResource SurfaceBrush}" 
                    BorderBrush="{DynamicResource BorderBrush}" 
                    BorderThickness="1" 
                    Padding="24" 
                    CornerRadius="8" 
                    Width="280" 
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center">
                <StackPanel>
                    <TextBlock Text="جارٍ المعالجة..." 
                               FontWeight="Bold" 
                               HorizontalAlignment="Center" 
                               Margin="0,0,0,12"/>
                    <ProgressBar IsIndeterminate="True" Height="6"/>
                    <TextBlock x:Name="lblLoadingMessage" 
                               Text="يرجى الانتظار..." 
                               FontSize="11" 
                               Foreground="{DynamicResource MutedBrush}" 
                               HorizontalAlignment="Center" 
                               Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>