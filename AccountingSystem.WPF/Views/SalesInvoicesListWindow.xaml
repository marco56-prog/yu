<Window x:Class="AccountingSystem.WPF.Views.SalesInvoicesListWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:models="clr-namespace:AccountingSystem.Models;assembly=AccountingSystem.Models"
        Title="فواتير البيع"
        Height="650" Width="1100"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        FlowDirection="RightToLeft"
        FontFamily="Segoe UI, Tahoma"
        FontSize="14"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <!-- Prefer centralized button styles from Resources/UnifiedStyles.xaml -->

        <!-- تلوين الصف حسب الحالة -->
        <Style TargetType="DataGridRow">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Style.Triggers>
                <!-- ملغية -->
                <DataTrigger Binding="{Binding Status}" Value="{x:Static models:InvoiceStatus.Cancelled}">
                    <Setter Property="Background" Value="#FFF5F5"/>
                    <Setter Property="Foreground" Value="#C53030"/>
                </DataTrigger>
                <!-- مسودة -->
                <DataTrigger Binding="{Binding Status}" Value="{x:Static models:InvoiceStatus.Draft}">
                    <Setter Property="Background" Value="#FFFEF3C7"/>
                    <Setter Property="Foreground" Value="#8B6C00"/>
                </DataTrigger>
                <!-- مؤكدة -->
                <DataTrigger Binding="{Binding Status}" Value="{x:Static models:InvoiceStatus.Confirmed}">
                    <Setter Property="Background" Value="#F0FFF4"/>
                    <Setter Property="Foreground" Value="#22543D"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- عنوان -->
            <RowDefinition Height="Auto"/>  <!-- أزرار وفلاتر -->
            <RowDefinition Height="*"/>    <!-- الجدول -->
            <RowDefinition Height="Auto"/>  <!-- الحالة -->
        </Grid.RowDefinitions>

        <!-- العنوان -->
        <TextBlock Grid.Row="0" Text="فواتير البيع"
                   FontSize="20" FontWeight="Bold"
                   HorizontalAlignment="Center"
                   Margin="0,10"/>

        <!-- أزرار التحكم والفلاتر -->
        <Border Grid.Row="1" BorderBrush="LightGray" BorderThickness="1"
                CornerRadius="5" Margin="10" Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- الأزرار -->
                    <RowDefinition Height="Auto"/> <!-- فلاتر رئيسية -->
                    <RowDefinition Height="Auto"/> <!-- شريط البحث -->
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- الأزرار -->
                <StackPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="4"
                            Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                    <Button Name="btnNew" Content="فاتورة جديدة"
                            Click="btnNew_Click"/>
                    <Button Name="btnEdit" Content="تعديل"
                            Style="{StaticResource ButtonStyle}" Click="btnEdit_Click"/>
                    <Button Name="btnView" Content="عرض"
                            Style="{StaticResource ButtonStyle}" Click="btnView_Click"/>
                    <Button Name="btnPost" Content="ترحيل"
                            Style="{StaticResource ButtonStyle}" Click="btnPost_Click"/>
                    <Button Name="btnCancel" Content="إلغاء"
                            Style="{StaticResource ButtonStyle}" Background="Red" Click="btnCancel_Click"/>
                    <Button Name="btnRefresh" Content="تحديث"
                            Style="{StaticResource ButtonStyle}" Click="btnRefresh_Click"/>
                </StackPanel>

                <!-- من تاريخ -->
                <StackPanel Grid.Row="1" Grid.Column="0" Margin="5">
                    <TextBlock Text="من تاريخ:" FontWeight="Bold"/>
                    <DatePicker Name="dpFromDate" SelectedDateChanged="Filter_SelectionChanged"/>
                </StackPanel>

                <!-- إلى تاريخ -->
                <StackPanel Grid.Row="1" Grid.Column="1" Margin="5">
                    <TextBlock Text="إلى تاريخ:" FontWeight="Bold"/>
                    <DatePicker Name="dpToDate" SelectedDateChanged="Filter_SelectionChanged"/>
                </StackPanel>

                <!-- العميل -->
                <StackPanel Grid.Row="1" Grid.Column="2" Margin="5">
                    <TextBlock Text="العميل:" FontWeight="Bold"/>
                    <ComboBox Name="cmbCustomer" DisplayMemberPath="CustomerName"
                              SelectionChanged="Filter_SelectionChanged"/>
                </StackPanel>

                <!-- الحالة -->
                <StackPanel Grid.Row="1" Grid.Column="3" Margin="5">
                    <TextBlock Text="الحالة:" FontWeight="Bold"/>
                    <ComboBox Name="cmbStatus" SelectionChanged="Filter_SelectionChanged">
                        <ComboBoxItem Content="جميع الحالات" Tag="" IsSelected="True"/>
                        <ComboBoxItem Content="مسودة" Tag="مسودة"/>
                        <ComboBoxItem Content="مؤكدة" Tag="مؤكدة"/>
                        <ComboBoxItem Content="ملغية" Tag="ملغية"/>
                    </ComboBox>
                </StackPanel>

                <!-- شريط البحث العام -->
                <DockPanel Grid.Row="2" Grid.ColumnSpan="4" Margin="5,10,5,0" LastChildFill="True">
                    <TextBlock Text="بحث عام:" Margin="0,0,8,0" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBox Name="txtSearch" Height="30" VerticalContentAlignment="Center"
                             ToolTip="اكتب أي جزء من (رقم/اسم عميل/إجمالي/الحالة)..."
                             TextChanged="Filter_TextChanged"/>
                    <CheckBox Name="chkPostedOnly" Content="مرحل فقط" Margin="10,0,0,0"
                              VerticalAlignment="Center" Checked="Filter_CheckChanged" Unchecked="Filter_CheckChanged"/>
                </DockPanel>
            </Grid>
        </Border>

        <!-- جدول الفواتير -->
        <DataGrid Grid.Row="2" Name="dgInvoices"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  SelectionMode="Single"
                  Margin="10"
                  IsReadOnly="True"
                  MouseDoubleClick="dgInvoices_MouseDoubleClick"
                  KeyDown="dgInvoices_KeyDown">
            <DataGrid.Columns>
                <DataGridTextColumn Header="رقم الفاتورة" Binding="{Binding InvoiceNumber}" Width="120"/>
                <DataGridTextColumn Header="التاريخ" Binding="{Binding InvoiceDate, StringFormat=yyyy-MM-dd}" Width="110"/>
                <DataGridTextColumn Header="العميل" Binding="{Binding Customer.CustomerName}" Width="*"/>
                <DataGridTextColumn Header="الإجمالي الفرعي" Binding="{Binding SubTotal, StringFormat=N2}" Width="130"/>
                <DataGridTextColumn Header="الضريبة" Binding="{Binding TaxAmount, StringFormat=N2}" Width="110"/>
                <DataGridTextColumn Header="الإجمالي" Binding="{Binding NetTotal, StringFormat=N2}" Width="130"/>
                <DataGridTextColumn Header="المدفوع" Binding="{Binding PaidAmount, StringFormat=N2}" Width="110"/>
                <DataGridTextColumn Header="المتبقي" Binding="{Binding RemainingAmount, StringFormat=N2}" Width="110"/>
                <DataGridTextColumn Header="الحالة" Binding="{Binding Status}" Width="90"/>
                <DataGridCheckBoxColumn Header="مرحل" Binding="{Binding IsPosted}" Width="70"/>
            </DataGrid.Columns>

            <!-- قائمة سياقية -->
            <DataGrid.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="عرض" Click="btnView_Click"/>
                    <MenuItem Header="تعديل" Click="btnEdit_Click"/>
                    <Separator/>
                    <MenuItem Header="ترحيل" Click="btnPost_Click"/>
                    <MenuItem Header="إلغاء" Click="btnCancel_Click"/>
                    <Separator/>
                    <MenuItem Header="تحديث" Click="btnRefresh_Click"/>
                </ContextMenu>
            </DataGrid.ContextMenu>
        </DataGrid>

        <!-- شريط الحالة -->
        <StatusBar Grid.Row="3">
            <StatusBarItem>
                <TextBlock Name="lblStatus" Text="جاهز"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Center">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="إجمالي المبيعات: " FontWeight="Bold"/>
                    <TextBlock Name="lblTotalSales" Text="0.00" Foreground="Green" FontWeight="Bold"/>
                    <TextBlock Text=" | عدد الفواتير: " FontWeight="Bold" Margin="20,0,0,0"/>
                    <TextBlock Name="lblCount" Text="0" FontWeight="Bold"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
